# STEP 5: Bootstrap Analysis - Sample ROWS (genes) with replacement

cat("\nSTEP 5: Bootstrap analysis (sampling genes)...\n")
cat("Question: Does entropy vary a lot if we resample genes?\n\n")

set.seed(42)
n_boot <- 100  # 100 bootstrap iterations as requested

# Get genes in both network and expression
valid_genes <- intersect(V(ppi_net)$name, rownames(expr_data))

cat("Running", n_boot, "bootstrap iterations\n")
cat("Sampling", length(valid_genes), "genes with replacement each time\n\n")

# Store bootstrap results
boot_entropy_list <- vector("list", n_boot)

for (b in 1:n_boot) {
  cat(sprintf("Bootstrap %d/%d\n", b, n_boot))
  
  # SAMPLE ROWS (genes) WITH REPLACEMENT
  boot_gene_indices <- sample(1:length(valid_genes), 
                              length(valid_genes), 
                              replace = TRUE)
  boot_genes <- valid_genes[boot_gene_indices]
  
  # Create bootstrapped expression matrix
  # Some genes appear multiple times, some not at all
  boot_expr <- expr_data[boot_genes, , drop = FALSE]
  
  # Make row names unique (add suffix for duplicates)
  boot_rownames <- make.unique(boot_genes, sep = "_")
  rownames(boot_expr) <- boot_rownames
  
  # Calculate entropy on bootstrapped data
  # For simplicity, calculate mean entropy across samples for each gene
  boot_result <- calc_entropy_per_sample(ppi_net, boot_expr, genes = unique(boot_genes))
  
  # Average across samples
  boot_mean_entropy <- rowMeans(boot_result$entropy_matrix, na.rm = TRUE)
  
  boot_entropy_list[[b]] <- boot_mean_entropy
  
  rm(boot_expr, boot_result)
  clean_mem()
}

# Analyze bootstrap distribution
cat("\nAnalyzing bootstrap results...\n")

# Get common genes across all bootstrap iterations
common_genes <- Reduce(intersect, lapply(boot_entropy_list, names))
cat("Genes in all bootstrap iterations:", length(common_genes), "\n")

if (length(common_genes) > 0) {
  # Create matrix: genes x bootstrap iterations
  boot_matrix <- matrix(NA, nrow = length(common_genes), ncol = n_boot)
  rownames(boot_matrix) <- common_genes
  
  for (b in 1:n_boot) {
    boot_matrix[, b] <- boot_entropy_list[[b]][common_genes]
  }
  
  # Calculate variability metrics
  boot_summary <- data.frame(
    gene = common_genes,
    mean = rowMeans(boot_matrix, na.rm = TRUE),
    sd = apply(boot_matrix, 1, sd, na.rm = TRUE),
    min = apply(boot_matrix, 1, min, na.rm = TRUE),
    max = apply(boot_matrix, 1, max, na.rm = TRUE),
    stringsAsFactors = FALSE
  )
  
  boot_summary$cv <- boot_summary$sd / boot_summary$mean
  boot_summary$range <- boot_summary$max - boot_summary$min
  
  cat("\nBootstrap Coefficient of Variation (CV) summary:\n")
  cat("Low CV (<0.1) = robust metric\n")
  cat("High CV (>0.2) = variable/non-robust metric\n\n")
  print(summary(boot_summary$cv))
  
  cat("\nGenes with HIGH variability (CV > 0.2):\n")
  high_var <- boot_summary %>%
    filter(cv > 0.2) %>%
    arrange(desc(cv)) %>%
    head(20)
  print(high_var)
  
  cat("\nGenes with LOW variability (CV < 0.05):\n")
  low_var <- boot_summary %>%
    filter(cv < 0.05) %>%
    arrange(cv) %>%
    head(20)
  print(low_var)
  
  # Overall assessment
  pct_robust <- 100 * sum(boot_summary$cv < 0.1, na.rm = TRUE) / nrow(boot_summary)
  cat(sprintf("\nOverall robustness: %.1f%% of genes have CV < 0.1\n", pct_robust))
  
  write.csv(boot_summary, "bootstrap_summary.csv", row.names = FALSE)
  
  # Save full bootstrap matrix for plotting
  write.csv(boot_matrix, "bootstrap_full_matrix.csv", row.names = TRUE)
}

rm(boot_entropy_list, boot_matrix)
clean_mem()
